<?xml version="1.0" encoding="UTF-8"?>
<project name="Tests" default="build_package" basedir=".">
	<target name="build_package">
		<phingcall target="export_repo" />
		<phingcall target="setup_properties" />
		<!-- <phingcall target="init" /> -->
		<!-- <phingcall target="package_component" /> -->
	</target>

	<target name="export_repo">
		<exec command="git archive --format tar --output build/export.tar.gz master" />
		<exec command="mkdir build/export" />
		<exec command="tar -xzf build/export.tar.gz -C build/export" />
	</target>

	<target name="setup_properties">
		<property name="path.root" value="build/export/www" />
		<property name="cmp.short" value="tests" />
		<property name="cmp.name" value="com_${cmp.short}" />
		<property name="cmp.admin_path" value="${path.root}/administrator/components/${cmp.name}" />
		<property name="cmp.admin_languages" value="${path.root}/administrator/language/en-GB" />
		<property name="cmp.site_path" value="${path.root}/components/${cmp.name}" />
		<property name="cmp.site_languages" value="${path.root}/language/en-GB" />

		<property name="joomla.version" value="2.5" />
		<exec command="xmllint --xpath '/extension/version/text()' ${cmp.admin_path}/${cmp.short}.xml" outputProperty="cmp.version" />

		<property name="zip.path" value="build/www" />
		<property name="package.path" value="${zip.path}/${cmp.name}" />

		<property name="package.name" value="${cmp.name}_v${cmp.version}_j${joomla_version}.zip" />
	</target>

	<target name="init">
		<available file="${package.path}" property="package.folder.exists" value="1" />
		<if>
			<equals arg1="${package.folder.exists}" arg2="1" />
			<then>
				<echo message="Deleting existing package folder..." />
				<delete dir="${package.path}" />
			</then>
		</if>

		<available file="${zip.path}/${package.name}" property="package.zip.exists" value="1" />
		<if>
			<equals arg1="${package.zip.exists}" arg2="1" />
			<then>
				<echo message="Deleting existing package zip..." />
				<delete dir="${zip.path}/${package.name}" />
			</then>
		</if>
	</target>

	<target name="package_component">
		<echo message="Building component..." />

		<!-- admin -->
		<copy todir="${package.path}/admin">
			<fileset dir="${cmp.admin_path}">
				<exclude name="${cmp.short}.xml" />
				<exclude name="script.php" />
			</fileset>
		</copy>

		<!-- site -->
		<copy todir="${package.path}/site">
			<fileset dir="${cmp.site_path}"/>
		</copy>

		<!-- languages -->
		<copy file="${cmp.admin_languages}/en-GB.${cmp.name}.ini" todir="${package.path}/admin/language/en-GB"/>
		<copy file="${cmp.admin_languages}/en-GB.${cmp.name}.sys.ini" todir="${package.path}/admin/language/en-GB"/>
		<copy file="${cmp.site_languages}/en-GB.${cmp.name}.ini" todir="${package.path}/site/language/en-GB"/>

		<!-- root files -->
		<copy file="${cmp.admin_path}/script.php" todir="${package.path}"/>
		<copy file="${cmp.admin_path}/${cmp.short}.xml" todir="${package.path}"/>

		<!-- plugins -->
		<copy todir="${package.path}/admin/extensions/plugins">
			<fileset dir="plugins/system/tests" />
		</copy>
		<!-- loop through plugins and and add the language files. uses plugin_folder -->
		<foreach param="plg_path" absparam="plg_abs_path" target="plugins_folder">
			<fileset dir="${package.path}/admin/extensions/plugins">
				<type type="dir" />
				<depth max="1" min="1" />
			</fileset>
		</foreach>

		<zip destfile="${zip.path}/${package.name}" basedir="${package.path}" />
	</target>

	<!-- called from foreach loop -->
	<target name="plugins_folder">
		<echo msg="${plg_abs_path}" />
		<php expression="str_replace('/', '_', '${plg_path}');" returnProperty="plg_lang_name" />
		<copy file="${cmp.admin_languages}/en-GB.plg_${plg_lang_name}.ini" todir="${plg_abs_path}/language/en-GB" />
		<copy file="${cmp.admin_languages}/en-GB.plg_${plg_lang_name}.sys.ini" todir="${plg_abs_path}/language/en-GB" />
	</target>
</project>